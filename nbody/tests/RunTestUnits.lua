
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
--local testSeed = testSeeds[math.random(1, #testSeeds)]
local testSeed = testSeeds[1]


refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 1593.542271768440060,
         ["886885833"] = 1594.485344628457597,
         ["715144259"] = 1588.104678578242101,
         ["430281807"] = 1598.126609484430446,
         ["543966758"] = 1587.240128399397236
      },

      ["1024"] = {
         ["670828913"] = 773.526784503378735,
         ["886885833"] = 679.714839819606823,
         ["715144259"] = 636.733948436223500,
         ["430281807"] = 682.080979935102732,
         ["543966758"] = 678.297278849129043
      },

      ["10000"] = {
         ["670828913"] = 2939.030774666311572,
         ["886885833"] = 3063.704982991576799,
         ["715144259"] = 3001.423066112746255,
         ["430281807"] = 2971.457413884076232,
         ["543966758"] = 2890.493231310966166
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 1601.287329827639496,
         ["886885833"] = 1617.469644449803809,
         ["715144259"] = 1597.879050544360553,
         ["430281807"] = 1603.838669524101306,
         ["543966758"] = 1606.039386613048009
      },

      ["1024"] = {
         ["670828913"] = 737.031505874622553,
         ["886885833"] = 1131.676430231929317,
         ["715144259"] = 787.951260369540250,
         ["430281807"] = 768.490602946515423,
         ["543966758"] = 829.656244753961573
      },

      ["10000"] = {
         ["670828913"] = 2833.712497720076044,
         ["886885833"] = 2896.132796705570399,
         ["715144259"] = 2871.555994260317675,
         ["430281807"] = 2844.960534798428853,
         ["543966758"] = 2832.398452999075289
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 1666.310807529433532,
         ["886885833"] = 1552.517376357815465,
         ["715144259"] = 1631.968441432825330,
         ["430281807"] = 1710.033537846361014,
         ["543966758"] = 1653.181088560538228
      },

      ["1024"] = {
         ["670828913"] = 2074.314208926211450,
         ["886885833"] = 2145.953628816133914,
         ["715144259"] = 2209.693169664059496,
         ["430281807"] = 2397.952657919261583,
         ["543966758"] = 2233.264048088137315
      },

      ["10000"] = {
         ["670828913"] = 8431.706360882439185,
         ["886885833"] = 8769.675737968527756,
         ["715144259"] = 8384.603918104190598,
         ["430281807"] = 8863.457447629014496,
         ["543966758"] = 8699.581107907060868
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 1577.955454719164891,
         ["886885833"] = 1594.125546027196151,
         ["715144259"] = 1579.463342663944786,
         ["430281807"] = 1580.951448819154393,
         ["543966758"] = 1578.270169551873551
      },

      ["1024"] = {
         ["670828913"] = 608.855071375099101,
         ["886885833"] = 707.529883442398614,
         ["715144259"] = 726.320128245308069,
         ["430281807"] = 731.127178539469810,
         ["543966758"] = 1012.884863149202374,
      },

      ["10000"] = {
         ["670828913"] = 2805.028628062690586,
         ["886885833"] = 2850.306498687348721,
         ["715144259"] = 2814.551600682010758,
         ["430281807"] = 2784.718708695526857,
         ["543966758"] = 2663.030206602332782
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 1591.958918195760816,
         ["886885833"] = 1616.779272415285504,
         ["715144259"] = 1597.561716043514252,
         ["430281807"] = 1631.322275089984487,
         ["543966758"] = 1573.298444940932086
      },

      ["1024"] = {
         ["670828913"] = 785.392740199442642,
         ["886885833"] = 738.813293560443071,
         ["715144259"] = 632.086804411697699,
         ["430281807"] = 1129.697238136163378,
         ["543966758"] = 827.194675840322475
      },

      ["10000"] = {
         ["670828913"] = 2757.668069791561720,
         ["886885833"] = 2993.359271450415235,
         ["715144259"] = 2974.383819466609111,
         ["430281807"] = 3005.299691298076141,
         ["543966758"] = 3234.577660074754021
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 3027.780983299112449,
         ["886885833"] = 3005.094474803918729,
         ["715144259"] = 3000.030906512155525,
         ["430281807"] = 3042.068590620005580,
         ["543966758"] = 2993.924309560577967
      },

      ["1024"] = {
         ["670828913"] = 3136.349289683392271,
         ["886885833"] = 3154.589965149260479,
         ["715144259"] = 3124.301898983138017,
         ["430281807"] = 3142.205718176477603,
         ["543966758"] = 3141.668075753233097
      },

      ["10000"] = {
         ["670828913"] = 2160.543966018401989,
         ["886885833"] = 2161.192765458571557,
         ["715144259"] = 2170.605591628587263,
         ["430281807"] = 2219.051769507782410,
         ["543966758"] = 2169.815678344272783
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 1576.268324397981587,
         ["886885833"] = 1603.138445667574388,
         ["715144259"] = 1596.512419494270034,
         ["430281807"] = 1593.640161084619649,
         ["543966758"] = 1602.859979841975701
      },

      ["1024"] = {
         ["670828913"] = 811.669940313729057,
         ["886885833"] = 760.302337352976451,
         ["715144259"] = 1031.785961502009513,
         ["430281807"] = 1103.265718177732651,
         ["543966758"] = 1089.138202210782083
      },

      ["10000"] = {
         ["670828913"] = 2456.984071524194860,
         ["886885833"] = 2439.881927186491794,
         ["715144259"] = 2516.537515687402902,
         ["430281807"] = 2642.804959788566066,
         ["543966758"] = 2490.575188165472355
      }

   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 1607.626861774637973,
         ["886885833"] = 1601.606122582590160,
         ["715144259"] = 1610.851578051190472,
         ["430281807"] = 1591.336934517174541,
         ["543966758"] = 1599.879133803070090
      },

      ["1024"] = {
         ["670828913"] = 1085.635534916312281,
         ["886885833"] = 1046.805891909323464,
         ["715144259"] = 1144.011275590801688,
         ["430281807"] = 1205.529530466230199,
         ["543966758"] = 816.906621383909965
      },

      ["10000"] = {
         ["670828913"] = 2050.249359143021593,
         ["886885833"] = 2172.163135309515383,
         ["715144259"] = 2096.189041419502246,
         ["430281807"] = 2084.863457635987743,
         ["543966758"] = 2098.359479819286662
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 1551.763827223560156,
         ["886885833"] = 1611.368618844031516,
         ["715144259"] = 1575.862467675231301,
         ["430281807"] = 1583.427788235845128,
         ["543966758"] = 1606.679775894963768
      },

      ["1024"] = {
         ["670828913"] = 835.316889853405428,
         ["886885833"] = 775.848656704707992,
         ["715144259"] = 659.754272487760318,
         ["430281807"] = 631.732711498639446,
         ["543966758"] = 632.432714448424576 
      },

      ["10000"] = {
         ["670828913"] = 2139.341244243906658,
         ["886885833"] = 2331.667834061052872,
         ["715144259"] = 2215.253797409814069,
         ["430281807"] = 2302.437594767320206,
         ["543966758"] = 2320.347773201031032
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 4198.359363610712535,
         ["886885833"] = 2270.350090342783915,
         ["715144259"] = 2555.121439667464983,
         ["430281807"] = 2238.327131359479154,
         ["543966758"] = 2372.928230273205827
      },

      ["1024"] = {
         ["670828913"] = 17442.218160550411994,
         ["886885833"] = 16725.812819854218105,
         ["715144259"] = 13537.736428474026980,
         ["430281807"] = 14624.964355516258365,
         ["543966758"] = 12602.773225381582961
      },

      ["10000"] = {
         ["670828913"] = 20172.526139474437514,
         ["886885833"] = 20204.702545046238811,
         ["715144259"] = 20098.940007973618776,
         ["430281807"] = 20072.748444144359382,
         ["543966758"] = 20116.770068521473149
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 1597.150466593015608,
         ["886885833"] = 1590.873046416112402,
         ["715144259"] = 1607.349004477490780,
         ["430281807"] = 1584.067380145896323,
         ["543966758"] = 1596.629807827567220
      },

      ["1024"] = {
         ["670828913"] = 1037.625494199738796,
         ["886885833"] = 929.070943879475635,
         ["715144259"] = 1021.979056253059980,
         ["430281807"] = 1122.744273431818783,
         ["543966758"] = 848.747218496152414
      },

      ["10000"] = {
         ["670828913"] = 2173.345627784093722,
         ["886885833"] = 2353.626719055680951,
         ["715144259"] = 2233.854063542311906,
         ["430281807"] = 2191.587979734810233,
         ["543966758"] = 2250.949157635286610
      }
   },


   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 1604.945517442427899,
         ["886885833"] = 1608.003924208210947,
         ["715144259"] = 1609.320155851446543,
         ["430281807"] = 1603.674994788616459,
         ["543966758"] = 1589.950889675956660
      },

      ["1024"] = {
         ["670828913"] = 860.190674973799560,
         ["886885833"] = 977.079871844298737,
         ["715144259"] = 901.454656734243827,
         ["430281807"] = 863.610275030854496,
         ["543966758"] = 973.613004992239212
      },

      ["10000"] = {
         ["670828913"] = 3543.807069740809766,
         ["886885833"] = 3696.201987194609956,
         ["715144259"] = 3493.790761655762708,
         ["430281807"] = 3711.449084718105496,
         ["543966758"] = 3567.210756660454535
      }
   },

   ["newhist_model_1"] = {
      ["100"] = {
         ["670828913"] = 1921.399019920596629,
         ["886885833"] = 2507.259567413587774,
         ["715144259"] = 2277.483069844485726,
         ["430281807"] = 1921.399019920596629,
         ["543966758"] = 1880.892858295289443
      },

      ["1024"] = {
         ["670828913"] = 4745.453858370087801,
         ["886885833"] = 5024.409732087724478,
         ["715144259"] = 5068.041460645472398,
         ["430281807"] = 5205.379022531156807,
         ["543966758"] = 5205.379022531156807
      },

      ["10000"] = {
         ["670828913"] = 12988.972447398160512,
         ["886885833"] = 13810.623768933184692,
         ["715144259"] = 13233.105481851351215,
         ["430281807"] = 13211.225057524350632,
         ["543966758"] = 13196.675140474046202
      }
   },

   ["newhist_model_2"] = {
      ["100"] = {
         ["670828913"] = 1609.590270961241231,
         ["886885833"] = 1651.020703246448420,
         ["715144259"] = 1637.497574410253719,
         ["430281807"] = 1691.965879082630636,
         ["543966758"] = 1673.613780795002867
      },

      ["1024"] = {
         ["670828913"] = 2227.660833501358411,
         ["886885833"] = 2315.765891129145984,
         ["715144259"] = 2218.976540229048169,
         ["430281807"] = 2221.856526162277078,
         ["543966758"] = 2322.599989602272672
      },

      ["10000"] = {
         ["670828913"] = 5487.594694945784795,
         ["886885833"] = 5448.047330770828012,
         ["715144259"] = 5644.313735281130903,
         ["430281807"] = 5619.263388670427958,
         ["543966758"] = 5506.644390509201003
      }
   },

   ["newhist_model_3"] = {
      ["100"] = {
         ["670828913"] = 20831.672944609566912,
         ["886885833"] = 4158.342887342659196,
         ["715144259"] = 20831.672944609566912,
         ["430281807"] = 20831.672944609566912,
         ["543966758"] = 20831.672944609566912
      },

      ["1024"] = {
         ["670828913"] = 19683.357772942861629,
         ["886885833"] = 19683.357772942861629,
         ["715144259"] = 20831.672944609566912,
         ["430281807"] = 20831.672944609566912,
         ["543966758"] = 19683.357772942861629
      },

      ["10000"] = {
         ["670828913"] = 20609.774305598719366,
         ["886885833"] = 20609.774305598719366,
         ["715144259"] = 20542.412593231350911,
         ["430281807"] = 20559.213177104018541,
         ["543966758"] = 20508.890734055767098
      }
   }
}



function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end


