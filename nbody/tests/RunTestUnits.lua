
require "NBodyTesting"
require "persistence"

local arg = {...}

assert(#arg == 5, "Test driver expected 5 arguments got " .. #arg)

local nbodyBinary = arg[1]
local testDir = arg[2]
local testName = arg[3]
local histogramName = arg[4]
local testBodies = arg[5]

local nbodyFlags = getExtraNBodyFlags()
eprintf("NBODY_FLAGS = %s\n", nbodyFlags)

math.randomseed(os.time())

-- Pick one of the random seeds used in generating these tests
local testSeeds = { "670828913", "886885833", "715144259", "430281807", "543966758" }
local testSeed = testSeeds[math.random(1, #testSeeds)]
--local testSeed = testSeeds[1]


refResults = {
   ["model_1"] = {
      ["100"] = {
         ["670828913"] = 2962.270480681827848,
         ["886885833"] = 2940.240630486509872,
         ["715144259"] = 2941.746189670052900,
         ["430281807"] = 2946.953586457521851,
         ["543966758"] = 2951.812619170464131
      },

      ["1024"] = {
         ["670828913"] = 515.595063274511631,
         ["886885833"] = 494.215706286648128,
         ["715144259"] = 397.967111737108439,
         ["430281807"] = 466.150612200432363,
         ["543966758"] = 465.107926011337668
      },

      ["10000"] = {
         ["670828913"] = 494.041053765577999,
         ["886885833"] = 532.129632589014136,
         ["715144259"] = 504.493305062477134,
         ["430281807"] = 486.375802676526291,
         ["543966758"] = 475.599842228236355
      }
   },

   ["model_2"] = {
      ["100"] = {
         ["670828913"] = 2975.607923882358136,
         ["886885833"] = 2946.041284808408363,
         ["715144259"] = 2956.618249035218014,
         ["430281807"] = 2954.706466735951381,
         ["543966758"] = 2950.913636137851881
      },

      ["1024"] = {
         ["670828913"] = 639.026250336924249,
         ["886885833"] = 783.599409565595465,
         ["715144259"] = 754.191291694662027,
         ["430281807"] = 763.478823932760633,
         ["543966758"] = 871.436631978918058
      },

      ["10000"] = {
         ["670828913"] = 528.660022673371600,
         ["886885833"] = 555.143068091261398,
         ["715144259"] = 520.399301719734467,
         ["430281807"] = 503.487914776972843,
         ["543966758"] = 529.398495096216607
      }
   },

   ["model_3"] = {
      ["100"] = {
         ["670828913"] = 2971.724581846463934,
         ["886885833"] = 2972.682619865727247,
         ["715144259"] = 2943.928457951059499,
         ["430281807"] = 3104.027332807339462,
         ["543966758"] = 3047.261100671892109
      },

      ["1024"] = {
         ["670828913"] = 1882.225966701078278,
         ["886885833"] = 2046.330306292718205,
         ["715144259"] = 1834.716147087431636,
         ["430281807"] = 2155.533497151694519,
         ["543966758"] = 2005.147817619336593
      },

      ["10000"] = {
         ["670828913"] = 2555.467482094029492,
         ["886885833"] = 2660.313011740772708,
         ["715144259"] = 2547.248211192626513,
         ["430281807"] = 2705.266327871026533,
         ["543966758"] = 2634.850297646053605
      }
   },

   ["model_4"] = {
      ["100"] = {
         ["670828913"] = 2939.986210199946072,
         ["886885833"] = 2936.242372442524356,
         ["715144259"] = 2950.243427148877799,
         ["430281807"] = 2941.587147308531712,
         ["543966758"] = 2944.754987680415525
      },

      ["1024"] = {
         ["670828913"] = 373.407693303686472,
         ["886885833"] = 615.528967407171308,
         ["715144259"] = 527.998437678106711,
         ["430281807"] = 557.158238400716982,
         ["543966758"] = 597.210953153113564
      },

      ["10000"] = {
         ["670828913"] = 477.254083688011065,
         ["886885833"] = 536.367046768640421,
         ["715144259"] = 474.838562033553217,
         ["430281807"] = 506.753579767947315,
         ["543966758"] = 435.823440755992181
      }
   },

   ["model_5"] = {
      ["100"] = {
         ["670828913"] = 2923.844312223706766,
         ["886885833"] = 2935.350950185728379,
         ["715144259"] = 2940.299973434303411,
         ["430281807"] = 2943.185667639507756,
         ["543966758"] = 2951.949694115800412
      },

      ["1024"] = {
         ["670828913"] = 883.818660232846128,
         ["886885833"] = 680.350300058196581,
         ["715144259"] = 574.112264923601288,
         ["430281807"] = 848.620116691475573,
         ["543966758"] = 761.820242386376549
      },

      ["10000"] = {
         ["670828913"] = 423.728405388226520,
         ["886885833"] = 498.615461901606920,
         ["715144259"] = 499.930660279127892,
         ["430281807"] = 510.257464082453566,
         ["543966758"] = 583.239648753696770
      }
   },

   ["model_5_bounds_test"] = {
      ["100"] = {
         ["670828913"] = 5910.887131652905737,
         ["886885833"] = 5921.448418353818852,
         ["715144259"] = 5933.367473304049781,
         ["430281807"] = 5978.106905539169929,
         ["543966758"] = 5920.388817218797158
      },

      ["1024"] = {
         ["670828913"] = 6039.018988979996720,
         ["886885833"] = 6047.079227254319449,
         ["715144259"] = 5992.452730420134685,
         ["430281807"] = 6044.466410610495586,
         ["543966758"] = 6056.142462394738686
      },

      ["10000"] = {
         ["670828913"] = 4220.904604991692395,
         ["886885833"] = 4225.203219320319477,
         ["715144259"] = 4234.573062827342255,
         ["430281807"] = 4361.944085202775568,
         ["543966758"] = 4253.087871714278663
      }
   },

   ["model_6"] = {
      ["100"] = {
         ["670828913"] = 2961.090186834901488,
         ["886885833"] = 2932.879552702916499,
         ["715144259"] = 2929.030922668341645,
         ["430281807"] = 2923.892924663019130,
         ["543966758"] = 2933.860698175793459
      },

      ["1024"] = {
         ["670828913"] = 750.761666974039485,
         ["886885833"] = 533.158773196140714,
         ["715144259"] = 731.585730354986140,
         ["430281807"] = 651.794261597091690,
         ["543966758"] = 622.373862519844238
      },

      ["10000"] = {
         ["670828913"] = 314.448683680816487,
         ["886885833"] = 349.532140468261446,
         ["715144259"] = 371.667903934665446,
         ["430281807"] = 398.842832740332085,
         ["543966758"] = 371.374053470448246
      }

   },

   ["model_7"] = {
      ["100"] = {
         ["670828913"] = 2934.400993529372954,
         ["886885833"] = 2937.086733486450612,
         ["715144259"] = 2934.574141036792298,
         ["430281807"] = 2940.764468370460690,
         ["543966758"] = 2938.301102172204992
      },

      ["1024"] = {
         ["670828913"] = 730.672264332897839,
         ["886885833"] = 697.780618816705442,
         ["715144259"] = 896.199448635835779,
         ["430281807"] = 1053.700108077543973,
         ["543966758"] = 739.592103017139038
      },

      ["10000"] = {
         ["670828913"] = 251.531181957638978,
         ["886885833"] = 298.802279908045762,
         ["715144259"] = 258.797907870365179,
         ["430281807"] = 287.308741280553363,
         ["543966758"] = 250.180353897265007
      }
   },

   ["model_8"] = {
      ["100"] = {
         ["670828913"] = 2956.096378043867389,
         ["886885833"] = 2940.886625470710896,
         ["715144259"] = 2948.595590963711402,
         ["430281807"] = 2933.440593883564361,
         ["543966758"] = 2929.779661751358162
      },

      ["1024"] = {
         ["670828913"] = 805.635690607965785,
         ["886885833"] = 548.104991975123994,
         ["715144259"] = 507.326737873244213,
         ["430281807"] = 576.890878573868463,
         ["543966758"] = 356.927908807500501 
      },

      ["10000"] = {
         ["670828913"] = 249.069496883493969,
         ["886885833"] = 323.619281015050888,
         ["715144259"] = 254.429180172644976,
         ["430281807"] = 292.391664710506916,
         ["543966758"] = 303.907183474437431
      }
   },

   ["model_9"] = {
      ["100"] = {
         ["670828913"] = 3980.002908190850576,
         ["886885833"] = 3437.186628382672097,
         ["715144259"] = 3354.598250309785726,
         ["430281807"] = 3395.536515443397548,
         ["543966758"] = 3423.893360342057349
      },

      ["1024"] = {
         ["670828913"] = 6871.075048919726214,
         ["886885833"] = 6882.054902222045712,
         ["715144259"] = 6409.938396020443179,
         ["430281807"] = 6593.889364905421644,
         ["543966758"] = 6240.159575421833324
      },

      ["10000"] = {
         ["670828913"] = 7035.883570851289733,
         ["886885833"] = 7076.826708059788871,
         ["715144259"] = 6996.734949381407205,
         ["430281807"] = 7006.094040091727948,
         ["543966758"] = 7115.999014311939391
      }
   },

   ["model_ninkovic"] = {
      ["100"] = {
         ["670828913"] = 2938.688469328878000,
         ["886885833"] = 2940.488944718808852,
         ["715144259"] = 2941.521664672593943,
         ["430281807"] = 2933.512897475653062,
         ["543966758"] = 2940.709278885540698
      },

      ["1024"] = {
         ["670828913"] = 753.492103432904742,
         ["886885833"] = 1068.493831610284587,
         ["715144259"] = 775.242173406890515,
         ["430281807"] = 818.053938389397331,
         ["543966758"] = 863.885441187853075
      },

      ["10000"] = {
         ["670828913"] = 341.447683130629230,
         ["886885833"] = 387.621527155538843,
         ["715144259"] = 359.257647925159745,
         ["430281807"] = 346.564514785638266,
         ["543966758"] = 369.153317310450007
      }
   },


   ["model_triaxial"] = {
      ["100"] = {
         ["670828913"] = 2969.461313059119220,
         ["886885833"] = 2985.858510971362648,
         ["715144259"] = 2981.551931554986822,
         ["430281807"] = 2980.574335944069389,
         ["543966758"] = 2975.054300640168549
      },

      ["1024"] = {
         ["670828913"] = 820.639267425753474,
         ["886885833"] = 948.882488621572293,
         ["715144259"] = 865.573949985011950,
         ["430281807"] = 804.202399130802746,
         ["543966758"] = 980.598012865530450
      },

      ["10000"] = {
         ["670828913"] = 839.031390050777986,
         ["886885833"] = 885.218016252539542,
         ["715144259"] = 757.348753434138075,
         ["430281807"] = 903.559235127309876,
         ["543966758"] = 779.164601359315043
      }
   },

   ["model_newhist1"] = {
      ["100"] = {
         ["670828913"] = 6102319.775238348171115,
         ["886885833"] = 6951269.565217147581279,
         ["715144259"] = 5190847.095085320062935,
         ["430281807"] = 3761930.196597724687308,
         ["543966758"] = 5653962.777469145134091
      },

      ["1024"] = {
         ["670828913"] = 2441672.292512421961874,
         ["886885833"] = 2795726.150423249229789,
         ["715144259"] = 1999330.013574270065874,
         ["430281807"] = 693459.971334934816696,
         ["543966758"] = 2509221.809957504738122
      },

      ["10000"] = {
         ["670828913"] = 2615.838276547437999,
         ["886885833"] = 2283.887303357413657,
         ["715144259"] = 2735.238234375421598,
         ["430281807"] = 2621.426890525223826,
         ["543966758"] = 2607.925069090109901
      }
   },

   ["model_newhist2"] = {
      ["100"] = {
         ["670828913"] = 7494899.046031083911657,
         ["886885833"] = 4728448.402748676948249,
         ["715144259"] = 7728974.552434004843235,
         ["430281807"] = 6336299.612545101903379,
         ["543966758"] = 5807816.585725879296660
      },

      ["1024"] = {
         ["670828913"] = 2688766.777535988017917,
         ["886885833"] = 1224530.309549123514444,
         ["715144259"] = 1497396.042365003610030,
         ["430281807"] = 1577120.227685633813962,
         ["543966758"] = 2035668.427606973098591
      },

      ["10000"] = {
         ["670828913"] = 1002.383861759939350,
         ["886885833"] = 1386.841934702412800,
         ["715144259"] = 1218.610960853095548,
         ["430281807"] = 1062.547616702483538,
         ["543966758"] = 1046.946817049097035
      }
   },

   ["model_newhist3"] = {
      ["100"] = {
         ["670828913"] = 4832362.478784701786935,
         ["886885833"] = 5685240.972029386088252,
         ["715144259"] = 7901927.984265713021159,
         ["430281807"] = 4918005.005876600742340,
         ["543966758"] = 5988597.646148370578885
      },

      ["1024"] = {
         ["670828913"] = 1094063.310423935763538,
         ["886885833"] = 2855909.982981170527637,
         ["715144259"] = 2769868.928757496643811,
         ["430281807"] = 474424.234364059462678,
         ["543966758"] = 1085837.290311922086403
      },

      ["10000"] = {
         ["670828913"] = 2481.211754928495793,
         ["886885833"] = 2336.787995675993443,
         ["715144259"] = 2346.777450564011815,
         ["430281807"] = 2474.588894562217774,
         ["543966758"] = 2303.443184687581379
      }
   }
}



function resultCloseEnough(a, b)
   return math.abs(a - b) < 1.0e-10
end

errFmtStr = [[
Result differs from expected:
   Expected = %20.15f  Actual = %20.15f  |Difference| = %20.15f
]]

function runCheckTest(testName, histogram, seed, nbody, ...)
   local fileResults, bodyResults
   local ret, result

   if not generatingResults then
      -- Check if the result exists first so we don't waste time on a useless test
      fileResults = assert(refResults[testName], "Didn't find result for test file")
      bodyResults = assert(fileResults[nbody], "Didn't find result with matching bodies")
      refResult = assert(bodyResults[seed], "Didn't find result with matching seed")
   end

   --eprintf("CHECKTEST - Before runFullTest\n")

   ret = runFullTest{
      nbodyBin  = nbodyBinary,
      testDir   = testDir,
      testName  = testName,
      histogram = histogram,
      seed      = seed,
      cached    = false,
      extraArgs = { nbody }
   }

   --eprintf(ret.."\n")
   --eprintf("CHECKTEST - Before findLikelihood\n")

   result = findLikelihood(ret, false)

   --eprintf("CHECKTEST - Before write(ret)\n")

   io.stdout:write(ret)

   if generatingResults then
      io.stderr:write(string.format("Test result: %d, %d, %s: %20.15f\n", nbody, seed, testName, result))
      return false
   end

   if result == nil then
      return true
   end

   --eprintf("CHECKTEST - Before notClose\n")

   local notClose = not resultCloseEnough(refResult, result)
   if notClose then
      io.stderr:write(string.format(errFmtStr, refResult, result, math.abs(result - refResult)))
   end

   return notClose
end

-- return true if passed
function testProbabilistic(resultFile, testName, histogram, nbody, iterations)
   local testTable, histTable, answer
   local resultTable = persisence.load(resultFile)
   assert(resultTable, "Failed to open result file " .. resultFile)

   testTable = assert(resultTable[testName], "Did not find result for test " .. testName)
   histTable = assert(testTable[nbody], "Did not find result for nbody " .. tostring(nbody))
   answer = assert(histTable[nbody], "Did not find result for histogram " .. histogram)

   local minAccepted = answer.mean - 3.0 * answer.stddev
   local maxAccepted = answer.mean + 3.0 * answer.stddev

   local result = 0.0
   local z = (result - answer.mean) / answer.stddev


   return true
end



function getResultName(testName)
   return string.format("%s__results.lua", testName)
end

if runCheckTest(testName, histogramName, testSeed, testBodies) then
   os.exit(1)
end


