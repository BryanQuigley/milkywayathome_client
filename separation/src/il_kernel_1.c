/*
 *  Copyright (c) 2010-2011 Matthew Arsenault
 *  Copyright (c) 2010-2011 Rensselaer Polytechnic Institute
 *
 *  This file is part of Milkway@Home.
 *
 *  Milkway@Home is free software: you may copy, redistribute and/or modify it
 *  under the terms of the GNU General Public License as published by the
 *  Free Software Foundation, either version 3 of the License, or (at your
 *  option) any later version.
 *
 *  This file is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "il_kernels.h"

const char* ilKernelSrc1 =
"il_cs_2_0\n"
"dcl_num_thread_per_group 64\n"
"; 1 stream kernel\n"
"dcl_cb cb0[10]\n"
"; Constant buffer that holds ABI data\n"
"dcl_cb cb1[15]\n"
"; Kernel arguments\n"
"dcl_cb cb2[72]\n"
"; I'm guessing the math constants AMD uses\n"
"dcl_cb cb3[8]\n"
"; ap constants\n"
"dcl_cb cb4[4]\n"
"; stream constants\n"
"dcl_cb cb5[128]\n"
"; sg_dx\n"
"dcl_raw_uav_id(%d)\n"
"dcl_literal l0, 0x00000000, 0x00000000, 0x00000000, 0x00000000\n"
"dcl_literal l9, 0x00000000, 0x3FE00000, 0x00000000, 0x00000000\n"
"dcl_literal l5, 0x00000000, 0x3FE80000, 0x00000000, 0x00000000\n"
"dcl_literal l7, 0x00000000, 0x3FF00000, 0x00000000, 0x00000000\n"
"dcl_literal l6, 0x00000000, 0xBFB00000, 0x00000000, 0x00000000\n"
"dcl_literal l16, 0x00000000, 0xBFE00000, 0x00000000, 0x00000000\n"
"dcl_literal l4, 0x00000000, 0xC0080000, 0x00000000, 0x00000000\n"
"dcl_literal l3, 0x00000008, 0x00000000, 0x00000000, 0x00000000\n"
"dcl_literal l2, 0x00000010, 0x00000000, 0x00000000, 0x00000000\n"
"dcl_literal l15, 0x389CEFDD, 0x3FABF3E7, 0x00000000, 0x00000000\n"
"dcl_literal l13, 0x47900215, 0x3F33185F, 0x00000000, 0x00000000\n"
"dcl_literal l11, 0x4D1D3B2F, 0x3EF52B5C, 0x00000000, 0x00000000\n"
"dcl_literal l8, 0x652B82FE, 0x3FF71547, 0x00000000, 0x00000000\n"
"dcl_literal l17, 0x667F3BCD, 0x3FF6A09E, 0x00000000, 0x00000000\n"
"dcl_literal l10, 0xB649A8F5, 0x3F84AA4E, 0x00000000, 0x00000000\n"
"dcl_literal l14, 0xD100E689, 0x3E8657CD, 0x00000000, 0x00000000\n"
"dcl_literal l12, 0xFEFA39EC, 0x3FE62E42, 0x00000000, 0x00000000\n"
"dcl_literal l1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF\n"
"dcl_arena_uav_id(8)\n"
"mov r17.x___, cb3[1].x\n"
"mov r18.x___, cb3[1].y\n"
"iadd r21.x___, vAbsTid0.x, cb0[6].x\n"
"mov r22.x___, r21.x\n"
"inegate r23.x___, cb1[9].x\n"
"iadd r24.x___, r22.x, r23.x\n"
"mov r27.x___, r24.x\n"
"umod r28.x___, r27.x, cb1[11].x\n"
"mov r31.x___, r28.x\n"
"udiv r32.x___, r27.x, cb1[11].x\n"
"mov r35.x___, r32.x\n"
"mov r36.x___, l2.x\n"
"mov r38.x___, l3.x\n"
"ult r43.x___, r35.x, cb1[10].x\n"
"ult r40.x___, r31.x, cb1[11].x\n"
"iand r46.x___, r43.x, r40.x\n"
"mov r49.x___, r46.x\n"
"if_logicalnz r49.x\n"
"mov r50.xy__, l0.xyyy\n"
";Zero streams\n"
"mov r52.xy__, l0.xyyy\n"
"mov r54.xy__, r52.xyyy\n"
"umul r55.x___, r36.x, r17.x\n"
"umul r60.x___, r55.x, r35.x\n"
"mov r65.x___, r60.x\n"
"iadd r66.x___, r65.x, cb1[3].x\n"
"mov r69.x___, r66.x\n"
"umul r70.x___, r36.x, r17.x\n"
"iadd r75.x___, r69.x, r70.x\n"
"mov r80.x___, r75.x\n"
"umul r81.x___, cb1[14].x, cb1[11].x\n"
"iadd r82.x___, r81.x, r31.x\n"
"mov r85.x___, r82.x\n"
"umul r86.x___, r36.x, r85.x\n"
"iadd r91.x___, r86.x, cb1[4].x\n"
"mov r94.x___, r91.x\n"
"umul r95.x___, r38.x, r85.x\n"
"iadd r100.x___, r95.x, cb1[5].x\n"
"mov r103.x___, r100.x\n"
";Read Trig\n"
"uav_raw_load_id(%d) r104, r94.x\n"
"mov r105, r104\n"
"mov r108, r105\n"
"uav_raw_load_id(%d) r109.xy__, r103.x\n"
"mov r110.xy__, r109.xy00\n"
"mov r113.xy__, r110.xyyy\n"
"whileloop\n"
"uav_raw_load_id(%d) r114, r69.x\n"
"mov r115, r114\n"
"mov r118, r115\n"
";coordinate conversion\n"
"dmad r125.xy__, r118.xyyy, r108.xyyy, cb3[2].xyyy\n"
"mov r128.xy__, r125.xyyy\n"
"dmul r135.xy__, r118.xyyy, r108.zwww\n"
"mov r138.xy__, r135.xyyy\n"
"dmul r142.xy__, r118.xyyy, r113.xyyy\n"
"mov r146.xy__, r142.xyyy\n"
";x^2 + y^2 + z^2 / q^2\n"
"dmul r147.xy__, r128.xyyy, r128.xyyy\n"
"mov r152.xy__, r147.xyyy\n"
"dmad r153.xy__, r138.xyyy, r138.xyyy, r152.xyyy\n"
"mov r160.xy__, r153.xyyy\n"
"dmul r161.xy__, r146.xyyy, r146.xyyy\n"
"mov r166.xy__, r161.xyyy\n"
"dmad r167.xy__, cb3[3].xyyy, r166.xyyy, r160.xyyy\n"
"mov r172.xy__, r167.xyyy\n"
";sqrt()\n"
"mov r173.xy__, r172.xyyy\n"
"mov r176, r173.xyyy\n"
"call 1\n"
"mov r174.xy__, r175\n"
"mov r173.xy__, r176\n"
"dadd r227.xy__, r174.xyyy, cb3[2].zwww\n"
"mov r230.xy__, r227.xyyy\n"
";qw_r3_N / (rg *rs^3)\n"
"dmul r231.xy__, r174.xyyy, r230.xyyy\n"
"dmul r236.xy__, r231.xyyy, r230.xyyy\n"
"dmul r241.xy__, r236.xyyy, r230.xyyy\n"
"mov r247.xy__, r241.xyyy\n"
"mov r251.xy__, r118.zwww\n"
"mov r254, r251.xyyy\n"
"mov r255, r247.xyyy\n"
"call 2\n"
"mov r252.xy__, r253\n"
"mov r251.xy__, r254\n"
"mov r247.xy__, r255\n"
"dadd r309.xy__, r50.xyyy, r252.xyyy\n"
"mov r50.xy__, r309.xyyy\n"
";stream loops\n"
";Begin stream\n"
";x - c\n"
"dadd r319.xy__, r128.xyyy, cb4[0].zwww_neg(y)\n"
"mov r322.xy__, r319.xyyy\n"
"dadd r324.xy__, r138.xyyy, cb4[1].zwww_neg(y)\n"
"mov r327.xy__, r324.xyyy\n"
"dadd r329.xy__, r146.xyyy, cb4[2].zwww_neg(y)\n"
"mov r332.xy__, r329.xyyy\n"
";a . x\n"
"dmul r334.xy__, cb4[0].xyyy, r322.xyyy\n"
"mov r337.xy__, r334.xyyy\n"
"dmad r339.xy__, cb4[1].xyyy, r327.xyyy, r337.xyyy\n"
"mov r337.xy__, r339.xyyy\n"
"dmad r345.xy__, cb4[2].xyyy, r332.xyyy, r337.xyyy\n"
"mov r337.xy__, r345.xyyy\n"
";xs += dotted * (-a)\n"
"mov r351.xy__, cb4[0].xyyy_neg(y)\n"
"dmad r352.xy__, r337.xyyy, r351.xyyy, r322.xyyy\n"
"mov r322.xy__, r352.xyyy\n"
"mov r358.xy__, cb4[1].xyyy_neg(y)\n"
"dmad r359.xy__, r337.xyyy, r358.xyyy, r327.xyyy\n"
"mov r327.xy__, r359.xyyy\n"
"mov r365.xy__, cb4[2].xyyy_neg(y)\n"
"dmad r366.xy__, r337.xyyy, r365.xyyy, r332.xyyy\n"
"mov r332.xy__, r366.xyyy\n"
";sqrv\n"
"dmul r371.xy__, r322.xyyy, r322.xyyy\n"
"mov r376.xy__, r371.xyyy\n"
"dmad r377.xy__, r327.xyyy, r327.xyyy, r376.xyyy\n"
"mov r376.xy__, r377.xyyy\n"
"dmad r384.xy__, r332.xyyy, r332.xyyy, r376.xyyy\n"
"mov r376.xy__, r384.xyyy\n"
";sqrv *= -sigma_sq2_inv\n"
"mov r391.xy__, cb4[3].xyyy_neg(y)\n"
"dmul r392.xy__, r376.xyyy, r391.xyyy\n"
"mov r376.xy__, r392.xyyy\n"
";increment stream integral\n"
"mov r395.xy__, r376.xyyy\n"
"mov r398, r395.xyyy\n"
"call 3\n"
"mov r396.xy__, r397\n"
"mov r395.xy__, r398\n"
"dmad r541.xy__, r118.zwww, r396.xyyy, r54.xyyy\n"
"mov r54.xy__, r541.xyyy\n"
";End streams\n"
"iadd r547.x___, r69.x, r36.x\n"
"mov r69.x___, r547.x\n"
"uge r552.x___, r69.x, r80.x\n"
"break_logicalnz r552.x\n"
"endloop\n"
"umul r557.x___, r31.x, cb1[10].x\n"
"iadd r560.x___, r557.x, r35.x\n"
"mov r564.x___, r560.x\n"
"umul r565.x___, r36.x, r35.x\n"
"iadd r570.x___, r565.x, cb1[2].x\n"
"uav_raw_load_id(%d) r573, r570.x\n"
"mov r574, r573\n"
"dmul r580.xy__, cb1[13].xyyy, r574.xyyy\n"
"mov r583.xy__, r580.xyyy\n"
";read old values\n"
"mov r584.x___, l3.x\n"
"umul r586.x___, r584.x, r564.x\n"
"iadd r591.x___, r586.x, cb1[0].x\n"
"uav_raw_load_id(%d) r594.xy__, r591.x\n"
"mov r595.xy__, r594.xy00\n"
"mov r598.xy__, r595.xyyy\n"
"mov r599.xy__, l0.xyyy\n"
"mov r601.x___, l0.x\n"
"mov r613.x___, l3.x\n"
"umul r603.x___, r18.x, r564.x\n"
"iadd r608.x___, r603.x, r601.x\n"
"umul r615.x___, r613.x, r608.x\n"
"iadd r621.x___, r615.x, cb1[1].x\n"
"uav_raw_load_id(%d) r626.xy__, r621.x\n"
"mov r627.xy__, r626.xy00\n"
"mov r599.xy__, r627.xyyy\n"
"mov r632.xy__, r599.xyyy\n"
";multiply V_reff_xr_rp3\n"
"dmad r633.xy__, r583.xyyy, r50.xyyy, r598.xyyy\n"
"mov r50.xy__, r633.xyyy\n"
"dmad r640.xy__, r583.xyyy, r54.xyyy, r632.xyyy\n"
"mov r54.xy__, r640.xyyy\n"
";Output\n"
"mov r647.x___, l3.x\n"
"umul r649.x___, r647.x, r564.x\n"
"iadd r654.x___, r649.x, cb1[0].x\n"
"uav_raw_store_id(%d) mem0.xy__, r654.x, r50.xyyy\n"
"mov r661.x___, l0.x\n"
"mov r673.x___, l3.x\n"
"umul r663.x___, r18.x, r564.x\n"
"iadd r668.x___, r663.x, r661.x\n"
"umul r675.x___, r673.x, r668.x\n"
"iadd r681.x___, r675.x, cb1[1].x\n"
"uav_raw_store_id(%d) mem0.xy__, r681.x, r54.xyyy\n"
"endif\n"
"endmain\n"
"func 2\n"
";div_custom\n"
"d2f r256.x___, r255.xyyy\n"
"mov r259.x___, r256.x\n"
"mov r260.x___, r259.x\n"
"rcp_zeroop(fltmax) r261.x___, r260.x\n"
"mov r264.x___, r261.x\n"
"f2d r265.xy__, r264.x\n"
"mov r268.xy__, r265.xyyy\n"
"mov r269.xy__, r255.xyyy_neg(y)\n"
"dmad r273.xy__, r269.xyyy, r268.xyyy, l7.xyyy\n"
"mov r277.xy__, r273.xyyy\n"
"dmad r278.xy__, r268.xyyy, r277.xyyy, r268.xyyy\n"
"mov r285.xy__, r278.xyyy\n"
"dmul r286.xy__, r254.xyyy, r285.xyyy\n"
"mov r291.xy__, r286.xyyy\n"
"mov r292.xy__, r255.xyyy_neg(y)\n"
"dmad r295.xy__, r292.xyyy, r291.xyyy, r254.xyyy\n"
"mov r301.xy__, r295.xyyy\n"
"dmad r302.xy__, r301.xyyy, r285.xyyy, r291.xyyy\n"
"mov r253.xy__, r302.xyyy\n"
"ret\n"
"endfunc\n"
"func 1\n"
";sqrt_custom\n"
"d2f r177.x___, r176.xyyy\n"
"mov r180.x___, r177.x\n"
"rsq_zeroop(fltmax) r181.x___, r180.x\n"
"mov r184.x___, r181.x\n"
"mov r185.x___, r184.x_neg(x)\n"
"f2d r188.xy__, r185.x\n"
"mov r190.xy__, r188.xyyy\n"
"dmul r191.xy__, r190.xyyy, r190.xyyy\n"
"mov r196.xy__, r191.xyyy\n"
"dmad r198.xy__, r176.xyyy, r196.xyyy, l4.xyyy\n"
"mov r196.xy__, r198.xyyy\n"
"dmul r203.xy__, r190.xyyy, r196.xyyy\n"
"mov r190.xy__, r203.xyyy\n"
"dmul r208.xy__, r176.xyyy, r190.xyyy\n"
"mov r196.xy__, r208.xyyy\n"
"dmul r213.xy__, r190.xyyy, r196.xyyy\n"
"mov r190.xy__, r213.xyyy\n"
"dmad r220.xy__, r190.xyyy, l6.xyyy, l5.xyyy\n"
"dmul r223.xy__, r196.xyyy, r220.xyyy\n"
"mov r175.xy__, r223.xyyy\n"
"ret\n"
"endfunc\n"
"func 3\n"
";exp_custom\n"
"dmul r400.xy__, r398.xyyy, l8.xyyy\n"
"mov r403.xy__, r400.xyyy\n"
"dfrac r404.xy__, r403.xyyy\n"
"mov r407.xy__, r404.xyyy\n"
"dadd r408.xy__, r403.xyyy, r407.xyyy_neg(y)\n"
"d2f r413.x___, r408.xyyy\n"
"ftoi r414.x___, r413.x\n"
"mov r417.x___, r414.x\n"
"dadd r419.xy__, r407.xyyy, l9.xyyy_neg(y)\n"
"mov r422.xy__, r419.xyyy\n"
"dmul r423.xy__, r422.xyyy, r422.xyyy\n"
"mov r428.xy__, r423.xyyy\n"
"dmad r431.xy__, r428.xyyy, l11.xyyy, l10.xyyy\n"
"mov r434.xy__, r431.xyyy\n"
"dmad r436.xy__, r428.xyyy, r434.xyyy, l12.xyyy\n"
"dmul r441.xy__, r422.xyyy, r436.xyyy\n"
"mov r446.xy__, r441.xyyy\n"
"dmad r449.xy__, r428.xyyy, l14.xyyy, l13.xyyy\n"
"mov r452.xy__, r449.xyyy\n"
"dmad r454.xy__, r428.xyyy, r452.xyyy, l15.xyyy\n"
"mov r452.xy__, r454.xyyy\n"
"dmad r460.xy__, r428.xyyy, r452.xyyy, l7.xyyy\n"
"mov r452.xy__, r460.xyyy\n"
"dmad r466.xy__, r446.xyyy, l16.xyyy, r452.xyyy\n"
"mov r471.xy__, r466.xyyy\n"
"mov r472.xy__, r471.xyyy\n"
"mov r473.xy__, r446.xyyy\n"
"mov r254, r473.xyyy\n"
"mov r255, r472.xyyy\n"
"call 2\n"
"mov r474.xy__, r253\n"
"mov r473.xy__, r254\n"
"mov r472.xy__, r255\n"
"dmad r530.xy__, r474.xyyy, l17.xyyy, l17.xyyy\n"
"mov r474.xy__, r530.xyyy\n"
"ldexp r533.xy__, r474.xyyy, r417.x\n"
"mov r397.xy__, r533.xyyy\n"
"ret\n"
"endfunc\n"
"end\n";

