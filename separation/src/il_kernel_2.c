/*
 *  Copyright (c) 2010-2011 Matthew Arsenault
 *  Copyright (c) 2010-2011 Rensselaer Polytechnic Institute
 *
 *  This file is part of Milkway@Home.
 *
 *  Milkway@Home is free software: you may copy, redistribute and/or modify it
 *  under the terms of the GNU General Public License as published by the
 *  Free Software Foundation, either version 3 of the License, or (at your
 *  option) any later version.
 *
 *  This file is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 *  General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include "il_kernels.h"

const char* ilKernelSrc2 =
"il_cs_2_0\n"
"dcl_num_thread_per_group 64\n"
"; 2 stream kernel\n"
"dcl_cb cb0[10]\n"
"; Constant buffer that holds ABI data\n"
"dcl_cb cb1[15]\n"
"; Kernel arguments\n"
"dcl_cb cb2[72]\n"
"; I'm guessing the math constants AMD uses\n"
"dcl_cb cb3[8]\n"
"; ap constants\n"
"dcl_cb cb4[8]\n"
"; stream constants\n"
"dcl_cb cb5[128]\n"
"; sg_dx\n"
"dcl_raw_uav_id(%d)\n"
"dcl_literal l0, 0x00000000, 0x00000000, 0x00000000, 0x00000000\n"
"dcl_literal l9, 0x00000000, 0x3FE00000, 0x00000000, 0x00000000\n"
"dcl_literal l5, 0x00000000, 0x3FE80000, 0x00000000, 0x00000000\n"
"dcl_literal l7, 0x00000000, 0x3FF00000, 0x00000000, 0x00000000\n"
"dcl_literal l6, 0x00000000, 0xBFB00000, 0x00000000, 0x00000000\n"
"dcl_literal l16, 0x00000000, 0xBFE00000, 0x00000000, 0x00000000\n"
"dcl_literal l4, 0x00000000, 0xC0080000, 0x00000000, 0x00000000\n"
"dcl_literal l18, 0x00000001, 0x00000000, 0x00000000, 0x00000000\n"
"dcl_literal l3, 0x00000008, 0x00000000, 0x00000000, 0x00000000\n"
"dcl_literal l2, 0x00000010, 0x00000000, 0x00000000, 0x00000000\n"
"dcl_literal l15, 0x389CEFDD, 0x3FABF3E7, 0x00000000, 0x00000000\n"
"dcl_literal l13, 0x47900215, 0x3F33185F, 0x00000000, 0x00000000\n"
"dcl_literal l11, 0x4D1D3B2F, 0x3EF52B5C, 0x00000000, 0x00000000\n"
"dcl_literal l8, 0x652B82FE, 0x3FF71547, 0x00000000, 0x00000000\n"
"dcl_literal l17, 0x667F3BCD, 0x3FF6A09E, 0x00000000, 0x00000000\n"
"dcl_literal l10, 0xB649A8F5, 0x3F84AA4E, 0x00000000, 0x00000000\n"
"dcl_literal l14, 0xD100E689, 0x3E8657CD, 0x00000000, 0x00000000\n"
"dcl_literal l12, 0xFEFA39EC, 0x3FE62E42, 0x00000000, 0x00000000\n"
"dcl_literal l1, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF, 0xFFFFFFFF\n"
"dcl_arena_uav_id(8)\n"
"mov r17.x___, cb3[1].x\n"
"mov r18.x___, cb3[1].y\n"
"iadd r21.x___, vAbsTid0.x, cb0[6].x\n"
"mov r22.x___, r21.x\n"
"inegate r23.x___, cb1[9].x\n"
"iadd r24.x___, r22.x, r23.x\n"
"mov r27.x___, r24.x\n"
"umod r28.x___, r27.x, cb1[11].x\n"
"mov r31.x___, r28.x\n"
"udiv r32.x___, r27.x, cb1[11].x\n"
"mov r35.x___, r32.x\n"
"mov r36.x___, l2.x\n"
"mov r38.x___, l3.x\n"
"ult r43.x___, r35.x, cb1[10].x\n"
"ult r40.x___, r31.x, cb1[11].x\n"
"iand r46.x___, r43.x, r40.x\n"
"mov r49.x___, r46.x\n"
"if_logicalnz r49.x\n"
"mov r50.xy__, l0.xyyy\n"
";Zero streams\n"
"mov r52.xy__, l0.xyyy\n"
"mov r54.xy__, r52.xyyy\n"
"mov r55.xy__, l0.xyyy\n"
"mov r57.xy__, r55.xyyy\n"
"mov r58.xy__, r54.xyyy\n"
"umul r59.x___, r36.x, r17.x\n"
"umul r64.x___, r59.x, r35.x\n"
"mov r69.x___, r64.x\n"
"iadd r70.x___, r69.x, cb1[3].x\n"
"mov r73.x___, r70.x\n"
"umul r74.x___, r36.x, r17.x\n"
"iadd r79.x___, r73.x, r74.x\n"
"mov r84.x___, r79.x\n"
"umul r85.x___, cb1[14].x, cb1[11].x\n"
"iadd r86.x___, r85.x, r31.x\n"
"mov r89.x___, r86.x\n"
"umul r90.x___, r36.x, r89.x\n"
"iadd r95.x___, r90.x, cb1[4].x\n"
"mov r98.x___, r95.x\n"
"umul r99.x___, r38.x, r89.x\n"
"iadd r104.x___, r99.x, cb1[5].x\n"
"mov r107.x___, r104.x\n"
";Read Trig\n"
"uav_raw_load_id(%d) r108, r98.x\n"
"mov r109, r108\n"
"mov r112, r109\n"
"uav_raw_load_id(%d) r113.xy__, r107.x\n"
"mov r114.xy__, r113.xy00\n"
"mov r117.xy__, r114.xyyy\n"
"whileloop\n"
"uav_raw_load_id(%d) r118, r73.x\n"
"mov r119, r118\n"
"mov r122, r119\n"
";coordinate conversion\n"
"dmad r129.xy__, r122.xyyy, r112.xyyy, cb3[2].xyyy\n"
"mov r132.xy__, r129.xyyy\n"
"dmul r139.xy__, r122.xyyy, r112.zwww\n"
"mov r142.xy__, r139.xyyy\n"
"dmul r146.xy__, r122.xyyy, r117.xyyy\n"
"mov r150.xy__, r146.xyyy\n"
";x^2 + y^2 + z^2 / q^2\n"
"dmul r151.xy__, r132.xyyy, r132.xyyy\n"
"mov r156.xy__, r151.xyyy\n"
"dmad r157.xy__, r142.xyyy, r142.xyyy, r156.xyyy\n"
"mov r164.xy__, r157.xyyy\n"
"dmul r165.xy__, r150.xyyy, r150.xyyy\n"
"mov r170.xy__, r165.xyyy\n"
"dmad r171.xy__, cb3[3].xyyy, r170.xyyy, r164.xyyy\n"
"mov r176.xy__, r171.xyyy\n"
";sqrt()\n"
"mov r177.xy__, r176.xyyy\n"
"mov r180, r177.xyyy\n"
"call 1\n"
"mov r178.xy__, r179\n"
"mov r177.xy__, r180\n"
"dadd r231.xy__, r178.xyyy, cb3[2].zwww\n"
"mov r234.xy__, r231.xyyy\n"
";qw_r3_N / (rg *rs^3)\n"
"dmul r235.xy__, r178.xyyy, r234.xyyy\n"
"dmul r240.xy__, r235.xyyy, r234.xyyy\n"
"dmul r245.xy__, r240.xyyy, r234.xyyy\n"
"mov r251.xy__, r245.xyyy\n"
"mov r255.xy__, r122.zwww\n"
"mov r258, r255.xyyy\n"
"mov r259, r251.xyyy\n"
"call 2\n"
"mov r256.xy__, r257\n"
"mov r255.xy__, r258\n"
"mov r251.xy__, r259\n"
"dadd r313.xy__, r50.xyyy, r256.xyyy\n"
"mov r50.xy__, r313.xyyy\n"
";stream loops\n"
";Begin stream\n"
";x - c\n"
"dadd r323.xy__, r132.xyyy, cb4[0].zwww_neg(y)\n"
"mov r326.xy__, r323.xyyy\n"
"dadd r328.xy__, r142.xyyy, cb4[1].zwww_neg(y)\n"
"mov r331.xy__, r328.xyyy\n"
"dadd r333.xy__, r150.xyyy, cb4[2].zwww_neg(y)\n"
"mov r336.xy__, r333.xyyy\n"
";a . x\n"
"dmul r338.xy__, cb4[0].xyyy, r326.xyyy\n"
"mov r341.xy__, r338.xyyy\n"
"dmad r343.xy__, cb4[1].xyyy, r331.xyyy, r341.xyyy\n"
"mov r341.xy__, r343.xyyy\n"
"dmad r349.xy__, cb4[2].xyyy, r336.xyyy, r341.xyyy\n"
"mov r341.xy__, r349.xyyy\n"
";xs += dotted * (-a)\n"
"mov r355.xy__, cb4[0].xyyy_neg(y)\n"
"dmad r356.xy__, r341.xyyy, r355.xyyy, r326.xyyy\n"
"mov r326.xy__, r356.xyyy\n"
"mov r362.xy__, cb4[1].xyyy_neg(y)\n"
"dmad r363.xy__, r341.xyyy, r362.xyyy, r331.xyyy\n"
"mov r331.xy__, r363.xyyy\n"
"mov r369.xy__, cb4[2].xyyy_neg(y)\n"
"dmad r370.xy__, r341.xyyy, r369.xyyy, r336.xyyy\n"
"mov r336.xy__, r370.xyyy\n"
";sqrv\n"
"dmul r375.xy__, r326.xyyy, r326.xyyy\n"
"mov r380.xy__, r375.xyyy\n"
"dmad r381.xy__, r331.xyyy, r331.xyyy, r380.xyyy\n"
"mov r380.xy__, r381.xyyy\n"
"dmad r388.xy__, r336.xyyy, r336.xyyy, r380.xyyy\n"
"mov r380.xy__, r388.xyyy\n"
";sqrv *= -sigma_sq2_inv\n"
"mov r395.xy__, cb4[3].xyyy_neg(y)\n"
"dmul r396.xy__, r380.xyyy, r395.xyyy\n"
"mov r380.xy__, r396.xyyy\n"
";increment stream integral\n"
"mov r399.xy__, r380.xyyy\n"
"mov r402, r399.xyyy\n"
"call 3\n"
"mov r400.xy__, r401\n"
"mov r399.xy__, r402\n"
"dmad r545.xy__, r122.zwww, r400.xyyy, r58.xyyy\n"
"mov r58.xy__, r545.xyyy\n"
";Begin stream\n"
";x - c\n"
"dadd r556.xy__, r132.xyyy, cb4[4].zwww_neg(y)\n"
"mov r559.xy__, r556.xyyy\n"
"dadd r561.xy__, r142.xyyy, cb4[5].zwww_neg(y)\n"
"mov r564.xy__, r561.xyyy\n"
"dadd r566.xy__, r150.xyyy, cb4[6].zwww_neg(y)\n"
"mov r569.xy__, r566.xyyy\n"
";a . x\n"
"dmul r571.xy__, cb4[4].xyyy, r559.xyyy\n"
"mov r574.xy__, r571.xyyy\n"
"dmad r576.xy__, cb4[5].xyyy, r564.xyyy, r574.xyyy\n"
"mov r574.xy__, r576.xyyy\n"
"dmad r582.xy__, cb4[6].xyyy, r569.xyyy, r574.xyyy\n"
"mov r574.xy__, r582.xyyy\n"
";xs += dotted * (-a)\n"
"mov r588.xy__, cb4[4].xyyy_neg(y)\n"
"dmad r589.xy__, r574.xyyy, r588.xyyy, r559.xyyy\n"
"mov r559.xy__, r589.xyyy\n"
"mov r595.xy__, cb4[5].xyyy_neg(y)\n"
"dmad r596.xy__, r574.xyyy, r595.xyyy, r564.xyyy\n"
"mov r564.xy__, r596.xyyy\n"
"mov r602.xy__, cb4[6].xyyy_neg(y)\n"
"dmad r603.xy__, r574.xyyy, r602.xyyy, r569.xyyy\n"
"mov r569.xy__, r603.xyyy\n"
";sqrv\n"
"dmul r608.xy__, r559.xyyy, r559.xyyy\n"
"mov r613.xy__, r608.xyyy\n"
"dmad r614.xy__, r564.xyyy, r564.xyyy, r613.xyyy\n"
"mov r613.xy__, r614.xyyy\n"
"dmad r621.xy__, r569.xyyy, r569.xyyy, r613.xyyy\n"
"mov r613.xy__, r621.xyyy\n"
";sqrv *= -sigma_sq2_inv\n"
"mov r628.xy__, cb4[7].xyyy_neg(y)\n"
"dmul r629.xy__, r613.xyyy, r628.xyyy\n"
"mov r613.xy__, r629.xyyy\n"
";increment stream integral\n"
"mov r632.xy__, r613.xyyy\n"
"mov r402, r632.xyyy\n"
"call 3\n"
"mov r633.xy__, r401\n"
"mov r632.xy__, r402\n"
"dmad r776.xy__, r122.zwww, r633.xyyy, r57.xyyy\n"
"mov r57.xy__, r776.xyyy\n"
";End streams\n"
"iadd r782.x___, r73.x, r36.x\n"
"mov r73.x___, r782.x\n"
"uge r787.x___, r73.x, r84.x\n"
"break_logicalnz r787.x\n"
"endloop\n"
"umul r792.x___, r31.x, cb1[10].x\n"
"iadd r795.x___, r792.x, r35.x\n"
"mov r799.x___, r795.x\n"
"umul r800.x___, r36.x, r35.x\n"
"iadd r805.x___, r800.x, cb1[2].x\n"
"uav_raw_load_id(%d) r808, r805.x\n"
"mov r809, r808\n"
"dmul r815.xy__, cb1[13].xyyy, r809.xyyy\n"
"mov r818.xy__, r815.xyyy\n"
";read old values\n"
"mov r819.x___, l3.x\n"
"umul r821.x___, r819.x, r799.x\n"
"iadd r826.x___, r821.x, cb1[0].x\n"
"uav_raw_load_id(%d) r829.xy__, r826.x\n"
"mov r830.xy__, r829.xy00\n"
"mov r833.xy__, r830.xyyy\n"
"mov r834.xy__, l0.xyyy\n"
"mov r836.x___, l0.x\n"
"mov r848.x___, l3.x\n"
"umul r838.x___, r18.x, r799.x\n"
"iadd r843.x___, r838.x, r836.x\n"
"umul r850.x___, r848.x, r843.x\n"
"iadd r856.x___, r850.x, cb1[1].x\n"
"uav_raw_load_id(%d) r861.xy__, r856.x\n"
"mov r862.xy__, r861.xy00\n"
"mov r834.xy__, r862.xyyy\n"
"mov r867.xy__, r834.xyyy\n"
"mov r868.xy__, l0.xyyy\n"
"mov r870.x___, l18.x\n"
"mov r882.x___, l3.x\n"
"umul r872.x___, r18.x, r799.x\n"
"iadd r877.x___, r872.x, r870.x\n"
"umul r884.x___, r882.x, r877.x\n"
"iadd r890.x___, r884.x, cb1[1].x\n"
"uav_raw_load_id(%d) r895.xy__, r890.x\n"
"mov r896.xy__, r895.xy00\n"
"mov r868.xy__, r896.xyyy\n"
"mov r901.xy__, r868.xyyy\n"
"mov r902.xy__, r867.xyyy\n"
";multiply V_reff_xr_rp3\n"
"dmad r903.xy__, r818.xyyy, r50.xyyy, r833.xyyy\n"
"mov r50.xy__, r903.xyyy\n"
"dmad r910.xy__, r818.xyyy, r58.xyyy, r902.xyyy\n"
"mov r58.xy__, r910.xyyy\n"
"dmad r917.xy__, r818.xyyy, r57.xyyy, r901.xyyy\n"
"mov r57.xy__, r917.xyyy\n"
";Output\n"
"mov r924.x___, l3.x\n"
"umul r926.x___, r924.x, r799.x\n"
"iadd r931.x___, r926.x, cb1[0].x\n"
"uav_raw_store_id(%d) mem0.xy__, r931.x, r50.xyyy\n"
"mov r938.x___, l0.x\n"
"mov r950.x___, l3.x\n"
"umul r940.x___, r18.x, r799.x\n"
"iadd r945.x___, r940.x, r938.x\n"
"umul r952.x___, r950.x, r945.x\n"
"iadd r958.x___, r952.x, cb1[1].x\n"
"uav_raw_store_id(%d) mem0.xy__, r958.x, r58.xyyy\n"
"mov r969.x___, l18.x\n"
"mov r981.x___, l3.x\n"
"umul r971.x___, r18.x, r799.x\n"
"iadd r976.x___, r971.x, r969.x\n"
"umul r983.x___, r981.x, r976.x\n"
"iadd r989.x___, r983.x, cb1[1].x\n"
"uav_raw_store_id(%d) mem0.xy__, r989.x, r57.xyyy\n"
"endif\n"
"endmain\n"
"func 2\n"
";div_custom\n"
"d2f r260.x___, r259.xyyy\n"
"mov r263.x___, r260.x\n"
"mov r264.x___, r263.x\n"
"rcp_zeroop(fltmax) r265.x___, r264.x\n"
"mov r268.x___, r265.x\n"
"f2d r269.xy__, r268.x\n"
"mov r272.xy__, r269.xyyy\n"
"mov r273.xy__, r259.xyyy_neg(y)\n"
"dmad r277.xy__, r273.xyyy, r272.xyyy, l7.xyyy\n"
"mov r281.xy__, r277.xyyy\n"
"dmad r282.xy__, r272.xyyy, r281.xyyy, r272.xyyy\n"
"mov r289.xy__, r282.xyyy\n"
"dmul r290.xy__, r258.xyyy, r289.xyyy\n"
"mov r295.xy__, r290.xyyy\n"
"mov r296.xy__, r259.xyyy_neg(y)\n"
"dmad r299.xy__, r296.xyyy, r295.xyyy, r258.xyyy\n"
"mov r305.xy__, r299.xyyy\n"
"dmad r306.xy__, r305.xyyy, r289.xyyy, r295.xyyy\n"
"mov r257.xy__, r306.xyyy\n"
"ret\n"
"endfunc\n"
"func 1\n"
";sqrt_custom\n"
"d2f r181.x___, r180.xyyy\n"
"mov r184.x___, r181.x\n"
"rsq_zeroop(fltmax) r185.x___, r184.x\n"
"mov r188.x___, r185.x\n"
"mov r189.x___, r188.x_neg(x)\n"
"f2d r192.xy__, r189.x\n"
"mov r194.xy__, r192.xyyy\n"
"dmul r195.xy__, r194.xyyy, r194.xyyy\n"
"mov r200.xy__, r195.xyyy\n"
"dmad r202.xy__, r180.xyyy, r200.xyyy, l4.xyyy\n"
"mov r200.xy__, r202.xyyy\n"
"dmul r207.xy__, r194.xyyy, r200.xyyy\n"
"mov r194.xy__, r207.xyyy\n"
"dmul r212.xy__, r180.xyyy, r194.xyyy\n"
"mov r200.xy__, r212.xyyy\n"
"dmul r217.xy__, r194.xyyy, r200.xyyy\n"
"mov r194.xy__, r217.xyyy\n"
"dmad r224.xy__, r194.xyyy, l6.xyyy, l5.xyyy\n"
"dmul r227.xy__, r200.xyyy, r224.xyyy\n"
"mov r179.xy__, r227.xyyy\n"
"ret\n"
"endfunc\n"
"func 3\n"
";exp_custom\n"
"dmul r404.xy__, r402.xyyy, l8.xyyy\n"
"mov r407.xy__, r404.xyyy\n"
"dfrac r408.xy__, r407.xyyy\n"
"mov r411.xy__, r408.xyyy\n"
"dadd r412.xy__, r407.xyyy, r411.xyyy_neg(y)\n"
"d2f r417.x___, r412.xyyy\n"
"ftoi r418.x___, r417.x\n"
"mov r421.x___, r418.x\n"
"dadd r423.xy__, r411.xyyy, l9.xyyy_neg(y)\n"
"mov r426.xy__, r423.xyyy\n"
"dmul r427.xy__, r426.xyyy, r426.xyyy\n"
"mov r432.xy__, r427.xyyy\n"
"dmad r435.xy__, r432.xyyy, l11.xyyy, l10.xyyy\n"
"mov r438.xy__, r435.xyyy\n"
"dmad r440.xy__, r432.xyyy, r438.xyyy, l12.xyyy\n"
"dmul r445.xy__, r426.xyyy, r440.xyyy\n"
"mov r450.xy__, r445.xyyy\n"
"dmad r453.xy__, r432.xyyy, l14.xyyy, l13.xyyy\n"
"mov r456.xy__, r453.xyyy\n"
"dmad r458.xy__, r432.xyyy, r456.xyyy, l15.xyyy\n"
"mov r456.xy__, r458.xyyy\n"
"dmad r464.xy__, r432.xyyy, r456.xyyy, l7.xyyy\n"
"mov r456.xy__, r464.xyyy\n"
"dmad r470.xy__, r450.xyyy, l16.xyyy, r456.xyyy\n"
"mov r475.xy__, r470.xyyy\n"
"mov r476.xy__, r475.xyyy\n"
"mov r477.xy__, r450.xyyy\n"
"mov r258, r477.xyyy\n"
"mov r259, r476.xyyy\n"
"call 2\n"
"mov r478.xy__, r257\n"
"mov r477.xy__, r258\n"
"mov r476.xy__, r259\n"
"dmad r534.xy__, r478.xyyy, l17.xyyy, l17.xyyy\n"
"mov r478.xy__, r534.xyyy\n"
"ldexp r537.xy__, r478.xyyy, r421.x\n"
"mov r401.xy__, r537.xyyy\n"
"ret\n"
"endfunc\n"
"end\n";

